!function(e,t){"function"==typeof define&&define.amd?define(t):"object"==typeof exports?module.exports=t(require,exports,module):e.Farmbot=t()}(this,function(e,t,n){return function(e){"use strict";function t(e){return this instanceof Farmbot?(this.options={},t.extend(this.options,[t.config.defaultOptions,e]),void t.requireKeys(this.options,t.config.requiredOptions)):new Farmbot(e)}return t.prototype.emergencyStop=function(){return this.send({params:{},method:"single_command.EMERGENCY STOP"})},t.prototype.execSequence=function(e){return this.send({params:e,method:"exec_sequence"})},t.prototype.homeAll=function(e){return t.requireKeys(e,["speed"]),this.send({params:e,method:"single_command.HOME ALL"})},t.prototype.homeX=function(e){return t.requireKeys(e,["speed"]),this.send({params:e,method:"single_command.HOME X"})},t.prototype.homeY=function(e){return t.requireKeys(e,["speed"]),this.send({params:e,method:"single_command.HOME Y"})},t.prototype.homeZ=function(e){return t.requireKeys(e,["speed"]),this.send({params:e,method:"single_command.HOME Z"})},t.prototype.moveAbsolute=function(e){return t.requireKeys(e,["speed"]),this.send({params:e,method:"single_command.MOVE ABSOLUTE"})},t.prototype.moveRelative=function(e){return t.requireKeys(e,["speed"]),this.send({params:e,method:"single_command.MOVE RELATIVE"})},t.prototype.pinWrite=function(e){return t.requireKeys(opts,["pin","value1","mode"]),this.send({params:opts,method:"single_command.PIN WRITE"})},t.prototype.readStatus=function(){return this.send({params:{},method:"read_status"})},t.prototype.syncSequence=function(){return console.warn("Not yet implemented"),this.send({params:{},method:"sync_sequence"})},t.prototype.updateCalibration=function(){return console.warn("Not yet implemented"),this.send({params:{},method:"update_calibration"})},t.config={requiredOptions:["uuid","token","meshServer","timeout"],defaultOptions:{speed:100,meshServer:"meshblu.octoblu.com",timeout:5e3}},t.prototype.event=function(e){return this.__events=this.__events||{},this.__events[e]=this.__events[e]||[],this.__events[e]},t.prototype.on=function(e,t){this.event(e).push(t)},t.prototype.emit=function(e,t){[this.event(e),this.event("*")].forEach(function(n){n.forEach(function(n){n(t,e)})})},t.prototype.buildMessage=function(e){var n=e||{},o={devices:n.devices||this.options.uuid,id:n.id||t.uuid()};return t.extend(n,[o]),t.requireKeys(n,["params","method","devices","id"]),n},t.prototype.sendRaw=function(e){if(this.socket){var t=this.buildMessage(e);return this.socket.send(JSON.stringify(["message",t])),t}throw new Error("You must connect() before sending data")},t.prototype.send=function(e){var n=this,o=n.sendRaw(e),r=t.timerDefer(n.options.timeout,o.method+" "+o.params);return n.on(o.id,function(e){var t=e&&e.result?r.resolve:r.reject;t(e)}),r},t.prototype.__newSocket=function(){return new WebSocket("ws://"+this.options.meshServer+"/ws/v2")},t.prototype.__onclose=function(){this.emit("disconnect",this)},t.prototype.__onmessage=function(e){var n=t.decodeFrame(e.data),o=n.message.id;o?this.emit(o,n.message):this.emit(n.name,n.message)},t.prototype.__newConnection=function(e){var n=this,o=t.timerDefer(n.options.timeout,"__newConnection");return n.socket=n.__newSocket(),n.socket.onopen=function(){n.socket.send(t.encodeFrame("identity",e))},n.socket.onmessage=n.__onmessage.bind(n),n.socket.onclose=n.__onclose.bind(n),n.on("ready",function(){o.resolve(n)}),o},t.prototype.connect=function(){function e(){n.socket.send(t.encodeFrame("subscribe",n)),o.resolve(n)}var n=this,o=t.timerDefer(n.options.timeout,"subscribing to device");return Farmbot.registerDevice().then(n.__newConnection.bind(n)).then(e)},t.defer=function(e){var t,n,o=new Promise(function(e,o){t=o,n=e});return o.finished=!1,o.reject=function(){o.finished=!0,t.apply(o,arguments)},o.resolve=function(){o.finished=!0,n.apply(o,arguments)},o.label=e||"a promise",o},t.timerDefer=function(e,n){n=n||"promise with "+e+" ms timeout";var o=t.defer(n);return setTimeout(function(){if(!o.finished){var e=new Error("`"+n+"` did not execute in time");o.reject(e)}},e),o},t.encodeFrame=function(e,t){return JSON.stringify([e,t])},t.decodeFrame=function(e){var t=JSON.parse(e);return{name:t[0],message:t[1]}},t.registerDevice=function(e,n){var n=n||"//meshblu.octoblu.com",e=e||3e3,o=new XMLHttpRequest,r=t.timerDefer(e,"registering device");return o.open("POST",n+"/devices?type=farmbotjs_client",!0),o.onload=function(){return o.status>=200&&o.status<400?r.resolve(JSON.parse(o.responseText)):r.reject(data)},o.onerror=r.reject,o.send(),r},t.extend=function(e,t){return t.forEach(function(t){var n=function(n){e[n]=t[n]};Object.keys(t).forEach(n)}),e},t.requireKeys=function(e,t){t.forEach(function(t){if(!(e||{})[t])throw new Error("Expected input object to have `"+t+"` property")})},t.uuid=function(){var e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",t=function(e){var t=16*Math.random()|0,n="x"===e?t:3&t|8;return n.toString(16)};return e.replace(/[xy]/g,t)},t.token=function(){for(var e=function(){var e=65536*(1+Math.random());return Math.floor(e).toString(16).substring(1)},t=10,n=[];t--;)n.push(e());return n.join("")},t.MeshErrorResponse=function(e){return{error:{method:"error",error:e||"unspecified error"}}},e.Farmbot=t,t}(this)});